name: ðŸš€ DÃ©ploiement UX Jobs Pro

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # Job de tests et validation
  test:
    name: ðŸ§ª Tests et Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Installer les dÃ©pendances
        run: npm ci

      - name: ðŸ” Audit de sÃ©curitÃ©
        run: |
          echo "ðŸ” Audit des dÃ©pendances..."
          npm audit --audit-level=high || true
          echo "âš ï¸ Note: Les vulnÃ©rabilitÃ©s modÃ©rÃ©es sont acceptÃ©es pour ce dÃ©ploiement"

      - name: ðŸ—ï¸ Build de l'application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: ðŸ§ª Tests (si disponibles)
        run: |
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test
          else
            echo "Aucun script de test trouvÃ©"
          fi

  # Job de dÃ©ploiement (seulement sur main)
  deploy:
    name: ðŸš€ DÃ©ploiement Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Installer les dÃ©pendances
        run: npm ci

      - name: ðŸ—ï¸ Build de l'application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: ðŸ“ CrÃ©er l'archive de dÃ©ploiement
        run: |
          tar -czf deploy.tar.gz \
            dist/ \
            server.js \
            package.json \
            package-lock.json \
            ecosystem.config.js \
            src/ \
            --exclude=node_modules \
            --exclude=.git \
            --exclude=.github \
            --exclude=scripts \
            --exclude=*.md

      - name: ðŸ” CrÃ©er le fichier .env de production
        run: |
          cat > .env << EOF
          # Configuration Supabase
          VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}
          
          # Configuration du serveur
          PORT=${{ secrets.PORT || '3001' }}
          NODE_ENV=production
          
          # Configuration de sÃ©curitÃ©
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          ADMIN_TOKEN_SECRET=${{ secrets.ADMIN_TOKEN_SECRET }}
          SESSION_SECRET=${{ secrets.SESSION_SECRET }}
          API_KEY=${{ secrets.API_KEY }}
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
          EOF

      - name: ðŸ“‚ TransfÃ©rer les fichiers via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          port: ${{ secrets.DEPLOY_PORT || '22' }}
          source: "deploy.tar.gz,.env"
          target: ${{ secrets.DEPLOY_PATH }}/current/

      - name: ðŸ”§ Installation et dÃ©marrage
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          port: ${{ secrets.DEPLOY_PORT || '22' }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}/current
            
            # Extraire l'archive
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz
            
            # Installer les dÃ©pendances de production
            npm ci --production
            
            # Installer PM2 si nÃ©cessaire
            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi
            
            # DÃ©marrage avec PM2 et configuration ecosystem
            if [ -f "ecosystem.config.js" ]; then
              pm2 start ecosystem.config.js --env production
            else
              pm2 start server.js --name "ux-jobs-pro" --env production
            fi
            
            # Sauvegarder la configuration PM2
            pm2 save
            pm2 startup

  # Job de notification simple
  notify:
    name: âœ… DÃ©ploiement TerminÃ©
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()
    
    steps:
      - name: ðŸ“‹ RÃ©sumÃ© du dÃ©ploiement
        run: |
          echo "ðŸš€ DÃ©ploiement UX Jobs Pro terminÃ©"
          echo "Status: ${{ job.status }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
