name: ðŸ§ª Test de DÃ©ploiement

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de test'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      skip_tests:
        description: 'Passer les tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  test-deployment:
    name: ðŸ§ª Test DÃ©ploiement ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Installer les dÃ©pendances
        run: npm ci

      - name: ðŸ§ª ExÃ©cuter les tests
        if: ${{ !github.event.inputs.skip_tests }}
        run: |
          echo "ðŸ§ª ExÃ©cution des tests..."
          # Ajouter vos tests ici quand ils seront disponibles
          echo "âœ… Tests simulÃ©s rÃ©ussis"

      - name: ðŸ” Audit de sÃ©curitÃ©
        run: |
          echo "ðŸ” Audit de sÃ©curitÃ©..."
          npm audit --audit-level=moderate || true

      - name: ðŸ—ï¸ Build de l'application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: ðŸ“ CrÃ©er l'archive de test
        run: |
          tar -czf test-deploy.tar.gz \
            dist/ \
            server.js \
            package.json \
            package-lock.json \
            ecosystem.config.js \
            src/ \
            --exclude=node_modules \
            --exclude=.git \
            --exclude=.github

      - name: ðŸ” CrÃ©er le fichier .env de test
        run: |
          cat > .env << EOF
          # Configuration Supabase
          VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}
          
          # Configuration du serveur
          PORT=${{ github.event.inputs.environment == 'production' && '3001' || '3002' }}
          NODE_ENV=${{ github.event.inputs.environment }}
          
          # Configuration de sÃ©curitÃ©
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          ADMIN_TOKEN_SECRET=${{ secrets.ADMIN_TOKEN_SECRET }}
          
          # Configuration de base de donnÃ©es
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          
          # Configuration de monitoring
          SENTRY_DSN=${{ secrets.SENTRY_DSN }}
          LOG_LEVEL=${{ secrets.LOG_LEVEL || 'info' }}
          EOF

      - name: ðŸ“¤ Upload de l'archive de test
        uses: actions/upload-artifact@v4
        with:
          name: test-deployment-${{ github.event.inputs.environment }}
          path: test-deploy.tar.gz
          retention-days: 7

      - name: ðŸ“‹ RÃ©sumÃ© du test
        run: |
          echo "## ðŸ§ª RÃ©sumÃ© du Test de DÃ©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Informations" >> $GITHUB_STEP_SUMMARY
          echo "- **Environnement:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests:** ${{ github.event.inputs.skip_tests && 'PassÃ©s' || 'ExÃ©cutÃ©s' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Fichiers gÃ©nÃ©rÃ©s" >> $GITHUB_STEP_SUMMARY
          echo "- Archive de dÃ©ploiement: \`test-deploy.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration: \`.env\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Prochaines Ã©tapes" >> $GITHUB_STEP_SUMMARY
          echo "1. TÃ©lÃ©charger l'archive depuis les artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Tester le dÃ©ploiement manuel" >> $GITHUB_STEP_SUMMARY
          echo "3. VÃ©rifier la configuration" >> $GITHUB_STEP_SUMMARY
          echo "4. DÃ©clencher le dÃ©ploiement automatique si tout est OK" >> $GITHUB_STEP_SUMMARY

  validate-config:
    name: ðŸ” Validation Configuration
    runs-on: ubuntu-latest
    needs: test-deployment
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ” VÃ©rifier les secrets requis
        run: |
          echo "ðŸ” VÃ©rification des secrets GitHub..."
          
          # Liste des secrets requis
          REQUIRED_SECRETS=(
            "VITE_SUPABASE_URL"
            "VITE_SUPABASE_ANON_KEY"
            "SUPABASE_SERVICE_KEY"
            "JWT_SECRET"
            "ADMIN_TOKEN_SECRET"
            "DEPLOY_HOST"
            "DEPLOY_USER"
            "DEPLOY_SSH_KEY"
            "DEPLOY_PATH"
          )
          
          echo "## ðŸ” Validation des Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for secret in "${REQUIRED_SECRETS[@]}"; do
            if [ -n "${!secret}" ]; then
              echo "| $secret | âœ… ConfigurÃ© |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $secret | âŒ Manquant |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Instructions" >> $GITHUB_STEP_SUMMARY
          echo "1. Allez sur **Settings** â†’ **Secrets and variables** â†’ **Actions**" >> $GITHUB_STEP_SUMMARY
          echo "2. Ajoutez les secrets manquants" >> $GITHUB_STEP_SUMMARY
          echo "3. Consultez \`SECRETS_SETUP.md\` pour plus de dÃ©tails" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“‹ Validation des fichiers
        run: |
          echo "ðŸ“‹ VÃ©rification des fichiers de configuration..."
          
          echo "## ðŸ“ Validation des Fichiers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # VÃ©rifier les fichiers requis
          FILES=(
            ".github/workflows/deploy.yml"
            ".github/workflows/security.yml"
            "ecosystem.config.js"
            "scripts/deploy.sh"
            "scripts/generate-secrets.sh"
            "SECRETS_SETUP.md"
            "DEPLOYMENT_GUIDE.md"
          )
          
          echo "| Fichier | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "| $file | âœ… PrÃ©sent |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $file | âŒ Manquant |" >> $GITHUB_STEP_SUMMARY
            fi
          done

  notify-completion:
    name: ðŸ“¢ Notification de Fin
    runs-on: ubuntu-latest
    needs: [test-deployment, validate-config]
    if: always()
    
    steps:
      - name: ðŸ“¢ Notification Slack (optionnel)
        if: ${{ secrets.SLACK_WEBHOOK_URL }}
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          text: |
            ðŸ§ª Test de DÃ©ploiement TerminÃ©
            Environnement: ${{ github.event.inputs.environment }}
            Status: ${{ job.status }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ðŸ“‹ RÃ©sumÃ© Final
        run: |
          echo "## ðŸŽ‰ Test de DÃ©ploiement TerminÃ©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š RÃ©sultats" >> $GITHUB_STEP_SUMMARY
          echo "- **Environnement:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests:** ${{ github.event.inputs.skip_tests && 'PassÃ©s' || 'ExÃ©cutÃ©s' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Prochaines Actions" >> $GITHUB_STEP_SUMMARY
          echo "1. VÃ©rifier les artifacts gÃ©nÃ©rÃ©s" >> $GITHUB_STEP_SUMMARY
          echo "2. Configurer les secrets manquants si nÃ©cessaire" >> $GITHUB_STEP_SUMMARY
          echo "3. DÃ©clencher le dÃ©ploiement automatique" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“š Documentation" >> $GITHUB_STEP_SUMMARY
          echo "- [Guide de DÃ©ploiement](DEPLOYMENT_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Configuration des Secrets](SECRETS_SETUP.md)" >> $GITHUB_STEP_SUMMARY
